---
// @ts-ignore
import loader from 'virtual:image-loader';
import { getImage } from '../src';
import type { ImageAttributes, ImageMetadata, TransformOptions, OutputFormat } from '../src/types';

export interface LocalImageProps extends Omit<TransformOptions, 'src'>, Omit<ImageAttributes, 'src'> {
	src: ImageMetadata;	
}

export interface RemoteImageProps extends TransformOptions, ImageAttributes {
	src: string;
	format: OutputFormat;
	width: number;
	height: number;
}

export type Props = LocalImageProps | RemoteImageProps;

function isLocalImage(props: Props): props is LocalImageProps {
	// vite-plugin-astro-image resolves ESM imported images
	// to a metadata object
	return typeof props.src !== 'string';
}

function resolveProps(props: Props): TransformOptions {
	if (!isLocalImage(props)) {
		return props;
	}

	let { width, height, aspectRatio, format, ...rest } = props;
	const { src, ...metadata } = props.src;

	if (!width && !height) {
		width = metadata.width;
		height = metadata.height;
	} else if (height || width) {
		aspectRatio = aspectRatio || metadata.width / metadata.height;
	}
	
	return {
		...rest,
		width,
		height,
		aspectRatio,
		src,
		format: format || metadata.format as OutputFormat,
	}
}

function calculateSize(transform: TransformOptions): TransformOptions {
	// keep width & height as provided
	if (transform.width && transform.height) {
		return transform;
	}

	if (!transform.width && !transform.height) {
		throw new Error(`"width" and "height" cannot both be undefined`);
	}

	if (!transform.aspectRatio) {
		throw new Error(`"aspectRatio" must be included if only "${transform.width ? "width": "height"}" is provided`)
	}

	let aspectRatio: number;

	// parse aspect ratio strings, if required (ex: "16:9")
	if (typeof transform.aspectRatio === 'number') {
		aspectRatio = transform.aspectRatio;
	} else {
		const [width, height] = transform.aspectRatio.split(':');
		aspectRatio = parseInt(width) / parseInt(height);
	}

	if (transform.width) {
	// only width was provided, calculate height
		return {
			...transform,
			width: transform.width,
			height: transform.width / aspectRatio
		};
	} else if (transform.height) {
	// only height was provided, calculate width
		return {
			...transform,
		width: transform.height * aspectRatio,
		height: transform.height
		}
	}

	return transform;
}

const props = Astro.props as Props;
const imageProps = calculateSize(resolveProps(props));

const attrs = await getImage(loader, imageProps);
---

<img {...attrs} />
